# Nome do Workflow (aparece na aba Actions do GitHub)
name: CI/CD - PWA Bootcamp

# Gatilhos: Quando este workflow deve rodar
on:
  push:
    branches: [ main ] # Em pushes para a branch main
  pull_request:
    branches: [ main ] # Em pull requests para a branch main

# Definição dos trabalhos (jobs) que o workflow executará
jobs:
  # Nome do job
  build-and-test:
    # Em qual tipo de máquina virtual o job rodará
    runs-on: ubuntu-latest

    # Lista de passos sequenciais que o job executará
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Habilita o cache de dependências npm
          # Procura por package-lock.json em qualquer subdiretório
          cache-dependency-path: '**/package-lock.json' 

      - name: Instalar Dependências (API)
        run: npm ci
        working-directory: ./apps/api # Executa na pasta api

      - name: Instalar Dependências (Web)
        run: npm ci
        working-directory: ./apps/web # Executa na pasta web

      - name: Rodar Testes Unitários (API) (se houver)
        run: npm test --if-present
        working-directory: ./apps/api

      - name: Instalar Navegadores Playwright
        run: npx playwright install --with-deps chromium
        working-directory: ./apps/web # Instala os navegadores para o app web

      - name: Construir Imagens Docker
        run: docker compose build
        # Não precisa de working-directory, pois o docker-compose.yml está na raiz

      - name: Subir Contêineres (API e Web)
        run: docker compose up -d # -d (detached) roda em segundo plano

      - name: Executar Testes E2E (Playwright)
        run: npm run test:e2e
        working-directory: ./apps/web
        # O Playwright (no host) vai testar http://localhost:8080,
        # que está mapeado para o contêiner 'web'

      - name: Parar Contêineres
        # 'if: always()' garante que este passo rode mesmo se os testes falharem
        if: always() 
        run: docker compose down # Desliga os contêineres

      # --- Upload de Artefatos ---
      # Precisamos construir o 'web' no host (fora do Docker)
      # apenas para ter a pasta 'dist' disponível para upload.
      - name: Construir PWA (para Artefato)
        run: npm run build
        working-directory: ./apps/web

      - name: Publicar Artefato (web-dist)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist/ # Caminho da pasta de build do Vite

      - name: Publicar Artefato (playwright-report)
        if: always() # Publica o relatório mesmo se os testes falharem
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: apps/web/playwright-report/ # Caminho do relatório do Playwright
          retention-days: 7